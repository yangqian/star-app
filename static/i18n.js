var translations = {
    en: {
        star_tracker: "⭐ Star Tracker",
        star_board: "Family Star Board",
        current_stars: "current stars",
        total_earned: "total earned",
        recent_stars: "Recent Stars",
        recent_redemptions: "Recent Redemptions",
        all: "All",
        kids: "Kids",
        parents: "Parents",
        selected: "Selected:",
        award_star: "Award Star",
        redeem: "Redeem",
        choose_reason: "Choose a reason",
        custom_reason: "Custom reason...",
        add: "Add",
        choose_reward: "Choose a reward",
        who: "Who",
        reason: "Reason",
        awarded_by: "Awarded By",
        when: "When",
        reward: "Reward",
        cost: "Cost",
        no_stars: "No stars yet!",
        no_redemptions: "No redemptions yet!",
        login: "Login",
        logout: "Logout",
        password: "Password",
        admin: "Admin",
        username: "Username",
        password_placeholder: "Password",
        change_password: "Change Password",
        current_password: "Current Password",
        new_password: "New Password",
        confirm_password: "Confirm New Password",
        update_password: "Update Password",
        admin_panel: "Admin Panel",
        award_a_star: "Award a Star",
        family_member: "Family Member",
        select: "Select...",
        what_did_they_do: "What did they do?",
        rewards: "Rewards",
        icon: "Icon",
        name: "Name",
        stars: "Stars",
        actions: "Actions",
        save: "Save",
        delete: "Delete",
        no_rewards: "No rewards configured",
        add_reward: "Add Reward",
        reward_name: "Reward name",
        api_keys: "API Keys",
        label: "Label",
        created: "Created",
        action: "Action",
        revoke: "Revoke",
        no_api_keys: "No API keys",
        generate_key: "Generate Key",
        label_placeholder: "Label (e.g. Home Assistant)",
        mode_individual: "Single",
        mode_multiple: "Multi",
        announce_on: "On",
        announce_off: "Off",
        ha_announce: "Home Assistant Announce",
        ha_enabled_label: "Enable announcements",
        ha_url_label: "Home Assistant TTS URL",
        ha_token_label: "Long-Lived Access Token",
        ha_media_player_label: "Media Player Entity",
        ha_lang_label: "Announce Language",
        ha_hint: "Leave blank to disable announcements.",
        count: "Count",
        award: "Award",
        no_reasons: "No reasons used yet",
        award_custom: "Award Custom",
        account: "Account",
        import_export: "Import / Export",
        export_data: "Export Data",
        import_data: "Import Data",
        import_export_hint: "Export creates a JSON backup. Import will replace all existing data.",
        retroactive: "Retroactive",
        role: "Role",
        add_user: "Add User",
        confirm_delete_user: "Delete user \"{name}\"? All their stars, redemptions and data will be removed."
    },
    "zh-CN": {
        star_tracker: "⭐ 星星记录",
        star_board: "家庭星星榜",
        current_stars: "当前星星",
        total_earned: "累计获得",
        recent_stars: "最近获得",
        recent_redemptions: "最近兑换",
        all: "全部",
        kids: "孩子",
        parents: "家长",
        selected: "已选择：",
        award_star: "奖励星星",
        redeem: "兑换",
        choose_reason: "选择原因",
        custom_reason: "自定义原因...",
        add: "添加",
        choose_reward: "选择奖品",
        who: "谁",
        reason: "原因",
        awarded_by: "奖励者",
        when: "时间",
        reward: "奖品",
        cost: "花费",
        no_stars: "还没有星星！",
        no_redemptions: "还没有兑换！",
        login: "登录",
        logout: "退出",
        password: "密码",
        admin: "管理",
        username: "用户名",
        password_placeholder: "密码",
        change_password: "修改密码",
        current_password: "当前密码",
        new_password: "新密码",
        confirm_password: "确认新密码",
        update_password: "修改密码",
        admin_panel: "管理面板",
        award_a_star: "奖励星星",
        family_member: "家庭成员",
        select: "请选择...",
        what_did_they_do: "做了什么？",
        rewards: "奖品",
        icon: "图标",
        name: "名称",
        stars: "星星",
        actions: "操作",
        save: "保存",
        delete: "删除",
        no_rewards: "暂无奖品",
        add_reward: "添加奖品",
        reward_name: "奖品名称",
        api_keys: "API 密钥",
        label: "标签",
        created: "创建时间",
        action: "操作",
        revoke: "撤销",
        no_api_keys: "暂无 API 密钥",
        generate_key: "生成密钥",
        label_placeholder: "标签（如 Home Assistant）",
        mode_individual: "单选",
        mode_multiple: "多选",
        announce_on: "开",
        announce_off: "关",
        ha_announce: "Home Assistant 播报",
        ha_enabled_label: "启用播报",
        ha_url_label: "Home Assistant TTS 地址",
        ha_token_label: "长期访问令牌",
        ha_media_player_label: "媒体播放器实体",
        ha_lang_label: "播报语言",
        ha_hint: "留空则不播报。",
        count: "次数",
        award: "奖励",
        no_reasons: "暂无使用过的原因",
        award_custom: "自定义奖励",
        account: "账户",
        import_export: "导入 / 导出",
        export_data: "导出数据",
        import_data: "导入数据",
        import_export_hint: "导出会创建 JSON 备份。导入将替换所有现有数据。",
        retroactive: "追溯修改",
        role: "角色",
        add_user: "添加用户",
        confirm_delete_user: "删除用户「{name}」？所有星星、兑换记录和数据都将被移除。"
    },
    "zh-TW": {
        star_tracker: "⭐ 星星記錄",
        star_board: "家庭星星榜",
        current_stars: "當前星星",
        total_earned: "累計獲得",
        recent_stars: "最近獲得",
        recent_redemptions: "最近兌換",
        all: "全部",
        kids: "孩子",
        parents: "家長",
        selected: "已選擇：",
        award_star: "獎勵星星",
        redeem: "兌換",
        choose_reason: "選擇原因",
        custom_reason: "自訂原因...",
        add: "新增",
        choose_reward: "選擇獎品",
        who: "誰",
        reason: "原因",
        awarded_by: "獎勵者",
        when: "時間",
        reward: "獎品",
        cost: "花費",
        no_stars: "還沒有星星！",
        no_redemptions: "還沒有兌換！",
        login: "登入",
        logout: "登出",
        password: "密碼",
        admin: "管理",
        username: "使用者名稱",
        password_placeholder: "密碼",
        change_password: "修改密碼",
        current_password: "目前密碼",
        new_password: "新密碼",
        confirm_password: "確認新密碼",
        update_password: "修改密碼",
        admin_panel: "管理面板",
        award_a_star: "獎勵星星",
        family_member: "家庭成員",
        select: "請選擇...",
        what_did_they_do: "做了什麼？",
        rewards: "獎品",
        icon: "圖示",
        name: "名稱",
        stars: "星星",
        actions: "操作",
        save: "儲存",
        delete: "刪除",
        no_rewards: "暫無獎品",
        add_reward: "新增獎品",
        reward_name: "獎品名稱",
        api_keys: "API 金鑰",
        label: "標籤",
        created: "建立時間",
        action: "操作",
        revoke: "撤銷",
        no_api_keys: "暫無 API 金鑰",
        generate_key: "產生金鑰",
        label_placeholder: "標籤（如 Home Assistant）",
        mode_individual: "單選",
        mode_multiple: "多選",
        announce_on: "開",
        announce_off: "關",
        ha_announce: "Home Assistant 播報",
        ha_enabled_label: "啟用播報",
        ha_url_label: "Home Assistant TTS 網址",
        ha_token_label: "長期存取權杖",
        ha_media_player_label: "媒體播放器實體",
        ha_lang_label: "播報語言",
        ha_hint: "留空則不播報。",
        count: "次數",
        award: "獎勵",
        no_reasons: "暫無使用過的原因",
        award_custom: "自訂獎勵",
        account: "帳戶",
        import_export: "匯入 / 匯出",
        export_data: "匯出資料",
        import_data: "匯入資料",
        import_export_hint: "匯出會建立 JSON 備份。匯入將替換所有現有資料。",
        retroactive: "追溯修改",
        role: "角色",
        add_user: "新增使用者",
        confirm_delete_user: "刪除使用者「{name}」？所有星星、兌換記錄和資料都將被移除。"
    }
};

var currentLang = localStorage.getItem('lang') || 'en';

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('lang', lang);
    applyLang();
}

function applyLang() {
    var dict = translations[currentLang] || translations.en;
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        if (dict[key] !== undefined) el.textContent = dict[key];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-placeholder');
        if (dict[key] !== undefined) el.placeholder = dict[key];
    });
    // Update lang switcher active state
    document.querySelectorAll('.lang-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.lang === currentLang);
    });
    // Update reason translations in reason panel
    var langKey = currentLang === 'zh-CN' ? 'zh-cn' : (currentLang === 'zh-TW' ? 'zh-tw' : 'en');
    document.querySelectorAll('.reason-trans').forEach(function(el) {
        var text = el.getAttribute('data-' + langKey) || el.getAttribute('data-en');
        var textEl = el.querySelector('.reason-text');
        if (textEl && text) textEl.textContent = text;
    });
    // Update reward translations in reward panel
    document.querySelectorAll('.reward-trans').forEach(function(el) {
        var text = el.getAttribute('data-' + langKey) || el.getAttribute('data-en');
        var textEl = el.querySelector('.reward-text');
        if (textEl && text) textEl.textContent = text;
    });
    // Update reward names in redemption history
    document.querySelectorAll('.reward-name').forEach(function(el) {
        var text = el.getAttribute('data-' + langKey) || el.getAttribute('data-en');
        if (text) el.textContent = text;
    });
    // Update user names
    document.querySelectorAll('.user-name').forEach(function(el) {
        var text = el.getAttribute('data-' + langKey) || el.getAttribute('data-en');
        if (text) el.textContent = text;
    });
    // Update time displays
    formatLocalTimes();
    // Update selected names display
    updateSelectedNamesDisplay();
    // Update star history reasons
    document.querySelectorAll('.star-reason').forEach(function(el) {
        var text = el.getAttribute('data-' + langKey) || el.getAttribute('data-en');
        if (text) {
            // Check if it's a consolidated display (starts with number)
            var currentText = el.textContent;
            var match = currentText.match(/^(\d+\s*×\s*)/);
            if (match) {
                el.textContent = match[1] + text;
            } else {
                el.textContent = text;
            }
        }
    });
}

function formatLocalTimes() {
    var locale = currentLang === 'zh-CN' ? 'zh-CN' : (currentLang === 'zh-TW' ? 'zh-TW' : 'en-US');
    document.querySelectorAll('.local-time').forEach(function(el) {
        var timeStr = el.getAttribute('data-time');
        if (timeStr) {
            var date = new Date(timeStr);
            // Format: Month Day HH:MM (e.g., "Jan 2 15:04" or "1月2日 15:04")
            var options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            var formatted = date.toLocaleString(locale, options);
            // Clean up formatting differences
            if (currentLang === 'en') {
                // For English, keep the format similar to "Jan 2 15:04"
                formatted = formatted.replace(',', '');
            }
            el.textContent = formatted;
        }
    });
}

function updateSelectedNamesDisplay() {
    var selectedNameEl = document.getElementById('selectedName');
    if (!selectedNameEl || typeof selectedUsers === 'undefined' || selectedUsers.length === 0) return;

    var langKey = currentLang === 'zh-CN' ? 'zh-cn' : (currentLang === 'zh-TW' ? 'zh-tw' : 'en');
    var translatedNames = selectedUsers.map(function(username) {
        var card = document.querySelector('.member-card[data-username="' + username + '"]');
        if (card) {
            var nameEl = card.querySelector('.user-name');
            if (nameEl) {
                return nameEl.getAttribute('data-' + langKey) || username;
            }
        }
        return username;
    });
    selectedNameEl.textContent = translatedNames.join(', ');
}

document.addEventListener('DOMContentLoaded', applyLang);
